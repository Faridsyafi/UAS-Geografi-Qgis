<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>WebGIS UAS Pandaan</title>
  <link rel="icon" href="data:,">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    /* Box UI */
    .box{
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      box-shadow:0 1px 10px rgba(0,0,0,.25);
      font:13px Arial, sans-serif;
      line-height:1.25;
      max-width: 340px;
    }
    .box .row{ display:flex; align-items:center; margin:4px 0; }
    .box .swatch{
      width:12px; height:12px; margin-right:8px;
      border:1px solid #ccc;
      border-radius:3px;
      flex: 0 0 auto;
    }
    .muted{ color:#666; font-size:12px; }
    .hr{ border:0; border-top:1px solid #eee; margin:8px 0; }

    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #eee;
      background:#fafafa;
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .btn:active{ transform: translateY(1px); }

    /* Legend collapsible */
    .legend-body{ margin-top:8px; }
    .hidden{ display:none; }

    /* Mobile responsive */
    @media (max-width: 768px){
      .box{
        max-width: 250px;
        padding:8px 10px;
        font-size:12px;
        border-radius:12px;
      }
      .muted{ font-size:11px; }
      .btn{ padding:7px 9px; font-size:12px; }
      /* geser biar nggak terlalu makan layar */
      .leaflet-top.leaflet-left { margin-top: 6px; }
      /* kecilkan kontrol zoom */
      .leaflet-control-zoom a{
        width:30px; height:30px; line-height:30px;
      }
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
/* =========================================================
   RESPONSIF untuk HP:
   - Legend dibuat bisa toggle (buka/tutup)
   - Box diperkecil di layar kecil
   - fitBounds agar fokus ke area data
========================================================= */

/* ===============================
   MAP & BASEMAP
=============================== */
const map = L.map("map", {
  zoomControl: true,
  scrollWheelZoom: true
}).setView([-7.653, 112.702], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

/* ===============================
   DATA CONTOH (GANTI DENGAN DATA ASLI KAMU)
=============================== */
const DATA_DESA = {
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","properties":{"id":1,"nama":"Desa A","kecamatan":"Pandaan","terlayani":1},
     "geometry":{"type":"Polygon","coordinates":[[[112.690,-7.645],[112.705,-7.645],[112.705,-7.655],[112.690,-7.655],[112.690,-7.645]]]}},
    {"type":"Feature","properties":{"id":2,"nama":"Desa B","kecamatan":"Pandaan","terlayani":0},
     "geometry":{"type":"Polygon","coordinates":[[[112.705,-7.645],[112.720,-7.645],[112.720,-7.655],[112.705,-7.655],[112.705,-7.645]]]}},
    {"type":"Feature","properties":{"id":3,"nama":"Desa C","kecamatan":"Pandaan","terlayani":1},
     "geometry":{"type":"Polygon","coordinates":[[[112.690,-7.655],[112.710,-7.655],[112.710,-7.665],[112.690,-7.665],[112.690,-7.655]]]}}
  ]
};

const DATA_SEKOLAH = {
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","properties":{"nama":"SD Negeri Contoh 1","jenis":"SD","desa":"Desa A","kecamatan":"Pandaan"},
     "geometry":{"type":"Point","coordinates":[112.697,-7.650]}},
    {"type":"Feature","properties":{"nama":"SMP Contoh 1","jenis":"SMP","desa":"Desa B","kecamatan":"Pandaan"},
     "geometry":{"type":"Point","coordinates":[112.712,-7.650]}},
    {"type":"Feature","properties":{"nama":"SMK Contoh 1","jenis":"SMK","desa":"Desa C","kecamatan":"Pandaan"},
     "geometry":{"type":"Point","coordinates":[112.701,-7.660]}}
  ]
};

const DATA_FASKES = {
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","properties":{"nama":"Puskesmas Contoh","tipe":"PUSKESMAS","desa":"Desa A","kecamatan":"Pandaan"},
     "geometry":{"type":"Point","coordinates":[112.700,-7.648]}},
    {"type":"Feature","properties":{"nama":"Pustu Contoh","tipe":"PUSTU","desa":"Desa C","kecamatan":"Pandaan"},
     "geometry":{"type":"Point","coordinates":[112.697,-7.662]}}
  ]
};

/* ===============================
   HELPER STYLE
=============================== */
function warnaSekolah(j){
  j=(j||"").toUpperCase();
  if(j==="SD") return "#1f77b4";
  if(j==="SMP") return "#2ca02c";
  if(j==="SMA") return "#d62728";
  if(j==="SMK") return "#9467bd";
  if(j==="TK") return "#ff7f0e";
  return "#111";
}
function warnaFaskes(t){
  t=(t||"").toUpperCase();
  if(t==="RS") return "#6a3d9a";
  if(t==="PUSKESMAS") return "#1b9e77";
  if(t==="PUSTU") return "#66a61e";
  return "#444";
}
function ukuranFaskes(t){
  t=(t||"").toUpperCase();
  if(t==="RS") return 9;
  if(t==="PUSKESMAS") return 7;
  if(t==="PUSTU") return 6;
  return 6;
}
function styleDesa(feature){
  const terlayani = Number(feature?.properties?.terlayani) === 1;
  return {
    color: "#2b2b2b",
    weight: 1,
    fillColor: terlayani ? "#2ecc71" : "#e74c3c",
    fillOpacity: 0.32
  };
}

/* ===============================
   LAYER DESA
=============================== */
const layerDesa = L.geoJSON(DATA_DESA, {
  style: styleDesa,
  onEachFeature: (f, layer) => {
    layer.on("click", (e) => {
      const p = f.properties || {};
      const status = (Number(p.terlayani) === 1) ? "Terlayani" : "Tidak Terlayani";
      L.popup()
        .setLatLng(e.latlng)
        .setContent(`
          <b>Info Desa (Faskes 1000 m)</b><br><br>
          <table border="1" cellpadding="6" style="border-collapse:collapse;font-size:12px">
            <tr><th>ID</th><td>${p.id ?? "-"}</td></tr>
            <tr><th>Nama</th><td>${p.nama ?? "-"}</td></tr>
            <tr><th>Kecamatan</th><td>${p.kecamatan ?? "-"}</td></tr>
            <tr><th>Status</th><td>${status}</td></tr>
          </table>
        `)
        .openOn(map);
    });
  }
}).addTo(map);

/* ===============================
   LAYER SEKOLAH
=============================== */
const layerSekolah = L.geoJSON(DATA_SEKOLAH, {
  pointToLayer: (f, ll) => L.circleMarker(ll, {
    radius: 6,
    color: "#fff",
    weight: 1,
    fillColor: warnaSekolah(f?.properties?.jenis),
    fillOpacity: 0.95
  }),
  onEachFeature: (f, l) => {
    const p = f.properties || {};
    l.bindPopup(`
      <b>${p.nama ?? "-"}</b><br>
      Jenis: ${p.jenis ?? "-"}<br>
      Desa: ${p.desa ?? "-"}<br>
      Kecamatan: ${p.kecamatan ?? "-"}
    `);
  }
}).addTo(map);

/* ===============================
   LAYER FASKES
=============================== */
const layerFaskes = L.geoJSON(DATA_FASKES, {
  pointToLayer: (f, ll) => L.circleMarker(ll, {
    radius: ukuranFaskes(f?.properties?.tipe),
    color: "#fff",
    weight: 1,
    fillColor: warnaFaskes(f?.properties?.tipe),
    fillOpacity: 0.95
  }),
  onEachFeature: (f, l) => {
    const p = f.properties || {};
    l.bindPopup(`
      <b>${p.nama ?? "-"}</b><br>
      Tipe: ${p.tipe ?? "-"}<br>
      Desa: ${p.desa ?? "-"}<br>
      Kecamatan: ${p.kecamatan ?? "-"}
    `);
  }
}).addTo(map);

/* ===============================
   FIT BOUNDS (biar HP langsung fokus area data)
=============================== */
try{
  const b = layerDesa.getBounds();
  if (b.isValid()) map.fitBounds(b, { padding:[20,20] });
}catch(e){}

/* ===============================
   TOGGLE LAYER
=============================== */
L.control.layers(null, {
  "Desa (Status Terlayani)": layerDesa,
  "Sekolah": layerSekolah,
  "Fasilitas Kesehatan": layerFaskes
}, { collapsed: true }).addTo(map);

/* ===============================
   BOX JUDUL (TOP LEFT)
=============================== */
const titleBox = L.control({ position: "topleft" });
titleBox.onAdd = function () {
  const div = L.DomUtil.create("div", "box");
  div.innerHTML = `
    <b>Fasilitas Publik</b><br>
    Sebaran lokasi sekolah & fasilitas kesehatan<br>
    dengan radius jangkauan layanan<br><br>
    <b>Kecamatan Pandaan</b>
    <hr class="hr">
    <b>UAS Web GIS</b><br>
    Farid Syafi R (012)<br>
    Andreas Natanael I (125)<br>
    Dwi Arif P (147)
  `;
  // biar klik/scroll di box nggak menggeser peta
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.disableScrollPropagation(div);
  return div;
};
titleBox.addTo(map);

/* ===============================
   RINGKASAN (TOP RIGHT)
=============================== */
const summary = L.control({ position: "topright" });
summary.onAdd = function () {
  const div = L.DomUtil.create("div", "box");
  // Angka ringkasan bisa kamu ganti manual sesuai hasil analisismu
  div.innerHTML = `
    <b>Ringkasan Data Pandaan</b>
    <table style="margin-top:6px;font-size:13px">
      <tr><td>Jumlah Desa</td><td style="padding-left:10px">: 18</td></tr>
      <tr><td>Desa Terlayani Faskes (1000 m)</td><td style="padding-left:10px">: 13</td></tr>
      <tr><td>Jumlah Sekolah</td><td style="padding-left:10px">: 18</td></tr>
      <tr><td>Jumlah Faskes</td><td style="padding-left:10px">: 6</td></tr>
    </table>
  `;
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.disableScrollPropagation(div);
  return div;
};
summary.addTo(map);

/* ===============================
   LEGENDA (BOTTOM RIGHT) - COLLAPSIBLE UNTUK HP
=============================== */
const legend = L.control({ position:"bottomright" });
legend.onAdd = function(){
  const d = L.DomUtil.create("div","box");

  // default: di HP legend disembunyikan biar nggak nutup peta
  const isMobile = window.matchMedia("(max-width: 768px)").matches;

  d.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <b>Legenda</b>
      <div class="btn" id="btnLegend">${isMobile ? "Tampilkan" : "Sembunyikan"}</div>
    </div>

    <div id="legendBody" class="legend-body ${isMobile ? "hidden" : ""}">
      <hr class="hr">
      <b>Legenda Sekolah</b>
      <div class='row'><span class='swatch' style='background:#1f77b4'></span>SD</div>
      <div class='row'><span class='swatch' style='background:#2ca02c'></span>SMP</div>
      <div class='row'><span class='swatch' style='background:#d62728'></span>SMA</div>
      <div class='row'><span class='swatch' style='background:#9467bd'></span>SMK</div>
      <div class='row'><span class='swatch' style='background:#ff7f0e'></span>TK</div>

      <hr class="hr">
      <b>Legenda Fasilitas Kesehatan</b>
      <div class='row'><span class='swatch' style='background:#6a3d9a'></span>Rumah Sakit</div>
      <div class='row'><span class='swatch' style='background:#1b9e77'></span>Puskesmas</div>
      <div class='row'><span class='swatch' style='background:#66a61e'></span>Pustu</div>

      <hr class="hr">
      <b>Interaksi</b><br>
      Klik titik = info sekolah / faskes<br>
      Klik area desa = info desa
    </div>
  `;

  // stop event supaya map tidak geser
  L.DomEvent.disableClickPropagation(d);
  L.DomEvent.disableScrollPropagation(d);

  // toggle
  setTimeout(() => {
    const btn = d.querySelector("#btnLegend");
    const body = d.querySelector("#legendBody");
    if (btn && body){
      btn.addEventListener("click", () => {
        body.classList.toggle("hidden");
        btn.textContent = body.classList.contains("hidden") ? "Tampilkan" : "Sembunyikan";
      });
    }
  }, 0);

  return d;
};
legend.addTo(map);

</script>
</body>
</html>
