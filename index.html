<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>WebGIS UAS Pandaan</title>
  <link rel="icon" href="data:,">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    .legend{
      background:#fff;
      padding:10px 12px;
      border-radius:8px;
      box-shadow:0 1px 6px rgba(0,0,0,.25);
      font:13px Arial;
    }
    .legend .row{ display:flex; align-items:center; margin:4px 0; }
    .legend .swatch{
      width:12px; height:12px; margin-right:8px;
      border:1px solid #ccc;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
/* ===============================
   KONFIG
=============================== */
const GEOSERVER = "http://localhost:8080/geoserver/uas_pandaan";
const WMS_URL = GEOSERVER + "/wms";
const OWS_URL = GEOSERVER + "/ows";
const LAYER_DESA = "uas_pandaan:v_desa_status_faskes1000";

/* ===============================
   MAP & BASEMAP
=============================== */
var map = L.map("map").setView([-7.65, 112.70], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

/* ===============================
   WMS DESA
=============================== */
L.tileLayer.wms(WMS_URL, {
  layers: LAYER_DESA,
  format: "image/png",
  transparent: true
}).addTo(map);

/* ===============================
   WFS SEKOLAH
=============================== */
const wfsSekolahUrl =
  OWS_URL +
  "?service=WFS&version=1.0.0&request=GetFeature" +
  "&typeName=uas_pandaan:sekolah&outputFormat=application/json&srsName=EPSG:4326";

function warnaSekolah(j){
  j=(j||"").toUpperCase();
  if(j==="SD") return "#1f77b4";
  if(j==="SMP") return "#2ca02c";
  if(j==="SMA") return "#d62728";
  if(j==="SMK") return "#9467bd";
  if(j==="TK") return "#ff7f0e";
  return "#000";
}

fetch(wfsSekolahUrl)
.then(r=>r.json())
.then(d=>{
  L.geoJSON(d,{
    pointToLayer:(f,ll)=>L.circleMarker(ll,{
      radius:6,
      color:"#fff",
      weight:1,
      fillColor:warnaSekolah(f.properties.jenis),
      fillOpacity:.95
    }),
    onEachFeature:(f,l)=>{
      const p=f.properties;
      l.bindPopup(
        `<b>${p.nama}</b><br>
         Jenis: ${p.jenis}<br>
         Desa: ${p.desa}<br>
         Kecamatan: ${p.kecamatan}`
      );
    }
  }).addTo(map);
});

/* ===============================
   WFS FASKES (WARNA TIDAK MERAH)
=============================== */
const wfsFaskesUrl =
  OWS_URL +
  "?service=WFS&version=1.0.0&request=GetFeature" +
  "&typeName=uas_pandaan:faskes&outputFormat=application/json&srsName=EPSG:4326";

function warnaFaskes(t){
  t=(t||"").toUpperCase();
  if(t==="RS") return "#6a3d9a";        // UNGU
  if(t==="PUSKESMAS") return "#1b9e77"; // HIJAU TUA
  if(t==="PUSTU") return "#66a61e";     // HIJAU MUDA
  return "#444";
}

function ukuranFaskes(t){
  t=(t||"").toUpperCase();
  if(t==="RS") return 9;
  if(t==="PUSKESMAS") return 7;
  if(t==="PUSTU") return 6;
  return 6;
}

fetch(wfsFaskesUrl)
.then(r=>r.json())
.then(d=>{
  L.geoJSON(d,{
    pointToLayer:(f,ll)=>L.circleMarker(ll,{
      radius: ukuranFaskes(f.properties.tipe),
      color:"#fff",
      weight:1,
      fillColor: warnaFaskes(f.properties.tipe),
      fillOpacity:.95
    }),
    onEachFeature:(f,l)=>{
      const p=f.properties;
      l.bindPopup(
        `<b>${p.nama}</b><br>
         Tipe: ${p.tipe}<br>
         Desa: ${p.desa}<br>
         Kecamatan: ${p.kecamatan}`
      );
    }
  }).addTo(map);
});

/* ===============================
   GETFEATUREINFO DESA
=============================== */
function getFeatureInfoUrl(latlng){
  const p = map.latLngToContainerPoint(latlng, map.getZoom());
  const s = map.getSize();
  const b = map.getBounds();

  return WMS_URL + L.Util.getParamString({
    service:"WMS",
    request:"GetFeatureInfo",
    version:"1.3.0",
    layers:LAYER_DESA,
    query_layers:LAYER_DESA,
    crs:"CRS:84",
    bbox:[b.getWest(),b.getSouth(),b.getEast(),b.getNorth()].join(","),
    width:s.x,
    height:s.y,
    i:Math.round(p.x),
    j:Math.round(p.y),
    info_format:"application/json",
    feature_count:1
  },WMS_URL,true);
}

map.on("click", async e=>{
  const res = await fetch(getFeatureInfoUrl(e.latlng));
  const json = await res.json();
  if(!json.features.length) return;

  const p=json.features[0].properties;
  const status = (p.terlayani==1) ? "Terlayani" : "Tidak Terlayani";

  L.popup().setLatLng(e.latlng).setContent(`
    <b>Info Desa (Faskes 1000 m)</b><br><br>
    <table border="1" cellpadding="6" style="border-collapse:collapse;font-size:12px">
      <tr><th>ID</th><td>${p.id}</td></tr>
      <tr><th>Nama</th><td>${p.nama}</td></tr>
      <tr><th>Kecamatan</th><td>${p.kecamatan}</td></tr>
      <tr><th>Status</th><td>${status}</td></tr>
    </table>
  `).openOn(map);
});

/* ===============================
   LEGENDA SEKOLAH + FASKES
=============================== */
const legend = L.control({position:"bottomright"});
legend.onAdd=function(){
  const d=L.DomUtil.create("div","legend");
  d.innerHTML=
    "<b>Legenda Sekolah</b>"+
    "<div class='row'><span class='swatch' style='background:#1f77b4'></span>SD</div>"+
    "<div class='row'><span class='swatch' style='background:#2ca02c'></span>SMP</div>"+
    "<div class='row'><span class='swatch' style='background:#d62728'></span>SMA</div>"+
    "<div class='row'><span class='swatch' style='background:#9467bd'></span>SMK</div>"+
    "<div class='row'><span class='swatch' style='background:#ff7f0e'></span>TK</div>"+
    "<hr><b>Legenda Fasilitas Kesehatan</b>"+
    "<div class='row'><span class='swatch' style='background:#6a3d9a'></span>Rumah Sakit</div>"+
    "<div class='row'><span class='swatch' style='background:#1b9e77'></span>Puskesmas</div>"+
    "<div class='row'><span class='swatch' style='background:#66a61e'></span>Pustu</div>"+
    "<hr><b>Interaksi</b><br>"+
    "Klik titik = info sekolah / faskes<br>"+
    "Klik area desa = info desa";
  return d;
};
legend.addTo(map);

/* ===============================
   RINGKASAN DATA PANDAAN
   (STATISTIK ANALISIS SPASIAL)
=============================== */
const summary = L.control({ position: "topright" });

summary.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Ringkasan Data Pandaan</b>
    <table style="margin-top:6px;font-size:13px">
      <tr><td>Jumlah Desa</td><td>: 18</td></tr>
      <tr><td>Desa Terlayani Faskes (1000 m)</td><td>: 13</td></tr>
      <tr><td>Jumlah Sekolah</td><td>: 18</td></tr>
      <tr><td>Jumlah Faskes</td><td>: 6</td></tr>
    </table>
  `;
  return div;
};

summary.addTo(map);

/* ===============================
   BOX JUDUL & IDENTITAS UAS
=============================== */
const titleBox = L.control({ position: "topleft" });

titleBox.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Fasilitas Publik</b><br>
    Sebaran lokasi sekolah & fasilitas kesehatan<br>
    dengan radius jangkauan layanan<br><br>

    <b>Kecamatan Pandaan</b><br>
    <hr style="margin:6px 0">

    <b>UAS Web GIS</b><br>
    Farid Syafi R (012)<br>
    Andreas N I (125)<br>
    Dwi Arif P (147)
  `;
  return div;
};

titleBox.addTo(map);


</script>
</body>
</html>
