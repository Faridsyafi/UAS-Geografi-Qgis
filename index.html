<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>WebGIS UAS Pandaan</title>
  <link rel="icon" href="data:,">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    .box{
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      box-shadow:0 1px 10px rgba(0,0,0,.25);
      font:13px Arial, sans-serif;
      line-height:1.25;
      max-width: 360px;
    }
    .box .row{ display:flex; align-items:center; margin:4px 0; }
    .box .swatch{
      width:12px; height:12px; margin-right:8px;
      border:1px solid #ccc;
      border-radius:3px;
      flex: 0 0 auto;
    }
    .muted{ color:#666; font-size:12px; }
    .hr{ border:0; border-top:1px solid #eee; margin:8px 0; }

    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #eee;
      background:#fafafa;
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .btn:active{ transform: translateY(1px); }
    .hidden{ display:none; }

    /* Mobile */
    @media (max-width: 768px){
      .box{ max-width: 250px; padding:8px 10px; font-size:12px; }
      .muted{ font-size:11px; }
      .btn{ padding:7px 9px; font-size:12px; }
      .leaflet-control-zoom a{ width:30px; height:30px; line-height:30px; }
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
/* =========================================================
  GitHub Pages-ready:
  - Tidak pakai GeoServer/localhost
  - Load data dari file GeoJSON di repo (folder /data)
========================================================= */

/* ===============================
   MAP & BASEMAP
=============================== */
const map = L.map("map").setView([-7.65, 112.70], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

/* ===============================
   PATH GEOJSON (RELATIF â†’ otomatis ikut domain GitHub Pages)
   Jadi ini akan bekerja di:
   https://faridsyafi.github.io/UAS-Geografi-Qgis/
=============================== */
const PATH_DESA    = "data/desa.geojson";
const PATH_SEKOLAH = "data/sekolah.geojson";
const PATH_FASKES  = "data/faskes.geojson";

/* ===============================
   STYLE HELPERS
=============================== */
function warnaSekolah(j){
  j=(j||"").toUpperCase();
  if(j==="SD") return "#1f77b4";
  if(j==="SMP") return "#2ca02c";
  if(j==="SMA") return "#d62728";
  if(j==="SMK") return "#9467bd";
  if(j==="TK") return "#ff7f0e";
  return "#111";
}

function warnaFaskes(t){
  t=(t||"").toUpperCase();
  if(t==="RS") return "#6a3d9a";
  if(t==="PUSKESMAS") return "#1b9e77";
  if(t==="PUSTU") return "#66a61e";
  return "#444";
}

function ukuranFaskes(t){
  t=(t||"").toUpperCase();
  if(t==="RS") return 9;
  if(t==="PUSKESMAS") return 7;
  if(t==="PUSTU") return 6;
  return 6;
}

function styleDesa(feature){
  const terlayani = Number(feature?.properties?.terlayani) === 1;
  return {
    color: "#2b2b2b",
    weight: 1,
    fillColor: terlayani ? "#2ecc71" : "#e74c3c",
    fillOpacity: 0.32
  };
}

/* ===============================
   GLOBAL LAYERS
=============================== */
let layerDesa = null;
let layerSekolah = null;
let layerFaskes = null;

/* ===============================
   POPUP HANDLERS
=============================== */
function onEachDesa(f, layer){
  layer.on("click", (e) => {
    const p = f.properties || {};
    const status = (Number(p.terlayani) === 1) ? "Terlayani" : "Tidak Terlayani";

    L.popup()
      .setLatLng(e.latlng)
      .setContent(`
        <b>Info Desa (Faskes 1000 m)</b><br><br>
        <table border="1" cellpadding="6" style="border-collapse:collapse;font-size:12px">
          <tr><th>ID</th><td>${p.id ?? "-"}</td></tr>
          <tr><th>Nama</th><td>${p.nama ?? "-"}</td></tr>
          <tr><th>Kecamatan</th><td>${p.kecamatan ?? "-"}</td></tr>
          <tr><th>Status</th><td>${status}</td></tr>
        </table>
      `)
      .openOn(map);
  });
}

function onEachSekolah(f, layer){
  const p = f.properties || {};
  layer.bindPopup(`
    <b>${p.nama ?? "-"}</b><br>
    Jenis: ${p.jenis ?? "-"}<br>
    Desa: ${p.desa ?? "-"}<br>
    Kecamatan: ${p.kecamatan ?? "-"}
  `);
}

function onEachFaskes(f, layer){
  const p = f.properties || {};
  layer.bindPopup(`
    <b>${p.nama ?? "-"}</b><br>
    Tipe: ${p.tipe ?? "-"}<br>
    Desa: ${p.desa ?? "-"}<br>
    Kecamatan: ${p.kecamatan ?? "-"}
  `);
}

/* ===============================
   LOAD GEOJSON
=============================== */
async function loadGeoJSON(url){
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok){
    throw new Error(`Gagal load: ${url} (HTTP ${res.status})`);
  }
  return await res.json();
}

async function init(){
  try{
    const [desa, sekolah, faskes] = await Promise.all([
      loadGeoJSON(PATH_DESA),
      loadGeoJSON(PATH_SEKOLAH),
      loadGeoJSON(PATH_FASKES)
    ]);

    // DESA
    layerDesa = L.geoJSON(desa, {
      style: styleDesa,
      onEachFeature: onEachDesa
    }).addTo(map);

    // SEKOLAH
    layerSekolah = L.geoJSON(sekolah, {
      pointToLayer: (f, ll) => L.circleMarker(ll, {
        radius: 6,
        color: "#fff",
        weight: 1,
        fillColor: warnaSekolah(f?.properties?.jenis),
        fillOpacity: 0.95
      }),
      onEachFeature: onEachSekolah
    }).addTo(map);

    // FASKES
    layerFaskes = L.geoJSON(faskes, {
      pointToLayer: (f, ll) => L.circleMarker(ll, {
        radius: ukuranFaskes(f?.properties?.tipe),
        color: "#fff",
        weight: 1,
        fillColor: warnaFaskes(f?.properties?.tipe),
        fillOpacity: 0.95
      }),
      onEachFeature: onEachFaskes
    }).addTo(map);

    // FIT BOUNDS (biar langsung fokus Pandaan)
    try{
      const b = layerDesa.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[20,20] });
    }catch(e){}

    // Layer control
    L.control.layers(null, {
      "Desa (Status Terlayani)": layerDesa,
      "Sekolah": layerSekolah,
      "Fasilitas Kesehatan": layerFaskes
    }, { collapsed: true }).addTo(map);

  }catch(err){
    console.error(err);
    alert(
      "Data GeoJSON tidak bisa dibaca.\n\n" +
      "Pastikan file ada di repo:\n" +
      "- data/desa.geojson\n" +
      "- data/sekolah.geojson\n" +
      "- data/faskes.geojson\n\n" +
      "Dan export dari QGIS pakai EPSG:4326.\n\n" +
      "Detail: " + err.message
    );
  }
}
init();

/* ===============================
   UI BOXES
=============================== */
const titleBox = L.control({ position: "topleft" });
titleBox.onAdd = function () {
  const div = L.DomUtil.create("div", "box");
  div.innerHTML = `
    <b>Fasilitas Publik</b><br>
    Sebaran lokasi sekolah & fasilitas kesehatan<br>
    dengan radius jangkauan layanan<br><br>
    <b>Kecamatan Pandaan</b>
    <hr class="hr">
    <b>UAS Web GIS</b><br>
    Farid Syafi R (012)<br>
    Andreas Natanael I (125)<br>
    Dwi Arif P (147)
  `;
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.disableScrollPropagation(div);
  return div;
};
titleBox.addTo(map);

const summary = L.control({ position: "topright" });
summary.onAdd = function () {
  const div = L.DomUtil.create("div", "box");
  div.innerHTML = `
    <b>Ringkasan Data Pandaan</b>
    <table style="margin-top:6px;font-size:13px">
      <tr><td>Jumlah Desa</td><td style="padding-left:10px">: 18</td></tr>
      <tr><td>Desa Terlayani Faskes (1000 m)</td><td style="padding-left:10px">: 13</td></tr>
      <tr><td>Jumlah Sekolah</td><td style="padding-left:10px">: 18</td></tr>
      <tr><td>Jumlah Faskes</td><td style="padding-left:10px">: 6</td></tr>
    </table>
    <div class="muted" style="margin-top:6px">Sumber basemap: OpenStreetMap</div>
  `;
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.disableScrollPropagation(div);
  return div;
};
summary.addTo(map);

/* ===============================
   LEGENDA (BOTTOM RIGHT) COLLAPSIBLE UNTUK HP
=============================== */
const legend = L.control({ position:"bottomright" });
legend.onAdd = function(){
  const d = L.DomUtil.create("div","box");
  const isMobile = window.matchMedia("(max-width: 768px)").matches;

  d.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <b>Legenda</b>
      <div class="btn" id="btnLegend">${isMobile ? "Tampilkan" : "Sembunyikan"}</div>
    </div>

    <div id="legendBody" class="${isMobile ? "hidden" : ""}" style="margin-top:8px">
      <hr class="hr">
      <b>Legenda Sekolah</b>
      <div class='row'><span class='swatch' style='background:#1f77b4'></span>SD</div>
      <div class='row'><span class='swatch' style='background:#2ca02c'></span>SMP</div>
      <div class='row'><span class='swatch' style='background:#d62728'></span>SMA</div>
      <div class='row'><span class='swatch' style='background:#9467bd'></span>SMK</div>
      <div class='row'><span class='swatch' style='background:#ff7f0e'></span>TK</div>

      <hr class="hr">
      <b>Legenda Fasilitas Kesehatan</b>
      <div class='row'><span class='swatch' style='background:#6a3d9a'></span>Rumah Sakit</div>
      <div class='row'><span class='swatch' style='background:#1b9e77'></span>Puskesmas</div>
      <div class='row'><span class='swatch' style='background:#66a61e'></span>Pustu</div>

      <hr class="hr">
      <b>Interaksi</b><br>
      Klik titik = info sekolah / faskes<br>
      Klik area desa = info desa
    </div>
  `;

  L.DomEvent.disableClickPropagation(d);
  L.DomEvent.disableScrollPropagation(d);

  setTimeout(() => {
    const btn = d.querySelector("#btnLegend");
    const body = d.querySelector("#legendBody");
    if (btn && body){
      btn.addEventListener("click", () => {
        body.classList.toggle("hidden");
        btn.textContent = body.classList.contains("hidden") ? "Tampilkan" : "Sembunyikan";
      });
    }
  }, 0);

  return d;
};
legend.addTo(map);
</script>
</body>
</html>
